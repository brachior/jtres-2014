{\scriptsize \begin{verbatim}
import static java.lang.invoke.MethodHandles.*;

public class RT {
    ...
  private static Object change(
      MutableCallSite callSite, Object[] arguments)
      throws Throwable {
    MethodHandle target;
    MethodType type = callSite.type();
    Class<?> aClass = arguments[0].getClass();
    if (aClass == Integer.class) {
      target = TARGET_INT.asType(type);
    } else if (aClass == String.class) {
      target = TARGET_STRING.asType(type);
    } else {
      throw new LinkageError("bad receiver class");
    }
    MethodHandle test =
      insertArguments(TARGET_CHECK, 1, aClass);
    test = dropArguments(test, 1, type.parameterType(1));
    callSite.setTarget(
      guardWithTest(test, target, callSite.getTarget()));
    return target.invokeWithArguments(arguments);
  }
    ...
}
\end{verbatim} }
